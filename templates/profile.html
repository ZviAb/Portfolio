<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Quiz App</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
  </head>
  <body>
    <div class="app">
      <div class="bg-decoration-1"></div>
      <div class="bg-decoration-2"></div>
      <div class="content">
        <header class="header">
          <div class="header-container">
            <div class="header-content">
              <div
                class="logo-section"
                style="cursor: pointer"
                onclick="window.location.href='/'"
              >
                <div class="logo-icon"><i data-lucide="brain"></i></div>
                <h1 class="logo-text">Quiz App</h1>
              </div>
              <div class="user-section">
                <div class="user-info">
                  <span class="user-name" id="userName">Guest</span>
                  <div class="avatar" id="avatar">
                    <i data-lucide="user"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <main style="padding: 2rem">
          <div style="max-width: 800px; margin: 0 auto">
            <div style="margin-bottom: 3rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="text-align: left;">
                  <h1 style="color: white; font-size: 2.5rem; margin-bottom: 0.5rem; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2)">
                    Profile Settings
                  </h1>
                  <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.2rem; margin: 0;">
                    Manage your account information
                  </p>
                </div>
                <button onclick="window.location.href='/dashboard'" style="background: white; color: #71ad98; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                  <i data-lucide="arrow-left" style="width: 1rem; height: 1rem;"></i>
                  Back to Dashboard
                </button>
              </div>
            </div>

            <!-- Single Profile Block -->
            <div
              style="
                background: white;
                border-radius: 1rem;
                padding: 2rem;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
              "
            >
              <!-- Personal Information Section -->
              <div style="margin-bottom: 3rem">
                <h2
                  style="
                    margin-bottom: 2rem;
                    color: #374151;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                  "
                >
                  <i
                    data-lucide="user-circle"
                    style="width: 1.5rem; height: 1.5rem; color: #71ad98"
                  ></i>
                  Personal Information
                </h2>

                <form id="profileForm">
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 1.5rem;
                      margin-bottom: 1.5rem;
                    "
                  >
                    <div>
                      <label
                        style="
                          display: block;
                          margin-bottom: 0.5rem;
                          color: #374151;
                          font-weight: 500;
                        "
                        >First Name</label
                      >
                      <input
                        type="text"
                        id="firstName"
                        required
                        style="
                          width: 100%;
                          padding: 0.75rem;
                          border: 1px solid #d1d5db;
                          border-radius: 0.375rem;
                          font-size: 1rem;
                        "
                      />
                    </div>

                    <div>
                      <label
                        style="
                          display: block;
                          margin-bottom: 0.5rem;
                          color: #374151;
                          font-weight: 500;
                        "
                        >Last Name</label
                      >
                      <input
                        type="text"
                        id="lastName"
                        required
                        style="
                          width: 100%;
                          padding: 0.75rem;
                          border: 1px solid #d1d5db;
                          border-radius: 0.375rem;
                          font-size: 1rem;
                        "
                      />
                    </div>
                  </div>

                  <div style="margin-bottom: 2rem">
                    <label
                      style="
                        display: block;
                        margin-bottom: 0.5rem;
                        color: #374151;
                        font-weight: 500;
                      "
                      >Email Address</label
                    >
                    <input
                      type="email"
                      id="email"
                      required
                      style="
                        width: 100%;
                        padding: 0.75rem;
                        border: 1px solid #d1d5db;
                        border-radius: 0.375rem;
                        font-size: 1rem;
                        background: #f9fafb;
                      "
                      readonly
                    />
                    <p
                      style="
                        color: #6b7280;
                        font-size: 0.875rem;
                        margin-top: 0.25rem;
                      "
                    >
                      Email cannot be changed
                    </p>
                  </div>

                  <div style="display: flex; gap: 1rem">
                    <button
                      type="submit"
                      style="
                        background: #71ad98;
                        color: white;
                        padding: 0.75rem 2rem;
                        border: none;
                        border-radius: 0.375rem;
                        cursor: pointer;
                        font-size: 1rem;
                        font-weight: 500;
                      "
                    >
                      Update Profile
                    </button>
                    <button
                      type="button"
                      id="cancelBtn"
                      style="
                        background: #6b7280;
                        color: white;
                        padding: 0.75rem 2rem;
                        border: none;
                        border-radius: 0.375rem;
                        cursor: pointer;
                        font-size: 1rem;
                        font-weight: 500;
                      "
                    >
                      Cancel
                    </button>
                  </div>
                </form>
              </div>

              <!-- Change Password Section -->
              <div style="margin-bottom: 3rem">
                <h2
                  style="
                    margin-bottom: 2rem;
                    color: #374151;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                  "
                >
                  <i
                    data-lucide="lock"
                    style="width: 1.5rem; height: 1.5rem; color: #71ad98"
                  ></i>
                  Change Password
                </h2>

                <form id="passwordForm">
                  <div style="margin-bottom: 1.5rem">
                    <label
                      style="
                        display: block;
                        margin-bottom: 0.5rem;
                        color: #374151;
                        font-weight: 500;
                      "
                      >Current Password</label
                    >
                    <input
                      type="password"
                      id="currentPassword"
                      required
                      style="
                        width: 100%;
                        padding: 0.75rem;
                        border: 1px solid #d1d5db;
                        border-radius: 0.375rem;
                        font-size: 1rem;
                      "
                    />
                  </div>

                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 1.5rem;
                      margin-bottom: 2rem;
                    "
                  >
                    <div>
                      <label
                        style="
                          display: block;
                          margin-bottom: 0.5rem;
                          color: #374151;
                          font-weight: 500;
                        "
                        >New Password</label
                      >
                      <input
                        type="password"
                        id="newPassword"
                        required
                        style="
                          width: 100%;
                          padding: 0.75rem;
                          border: 1px solid #d1d5db;
                          border-radius: 0.375rem;
                          font-size: 1rem;
                        "
                      />
                    </div>

                    <div>
                      <label
                        style="
                          display: block;
                          margin-bottom: 0.5rem;
                          color: #374151;
                          font-weight: 500;
                        "
                        >Confirm New Password</label
                      >
                      <input
                        type="password"
                        id="confirmPassword"
                        required
                        style="
                          width: 100%;
                          padding: 0.75rem;
                          border: 1px solid #d1d5db;
                          border-radius: 0.375rem;
                          font-size: 1rem;
                        "
                      />
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem">
                    <button
                      type="submit"
                      style="
                        background: #ef4444;
                        color: white;
                        padding: 0.75rem 2rem;
                        border: none;
                        border-radius: 0.375rem;
                        cursor: pointer;
                        font-size: 1rem;
                        font-weight: 500;
                      "
                    >
                      Change Password
                    </button>
                    <button
                      type="button"
                      id="cancelPasswordBtn"
                      style="
                        background: #6b7280;
                        color: white;
                        padding: 0.75rem 2rem;
                        border: none;
                        border-radius: 0.375rem;
                        cursor: pointer;
                        font-size: 1rem;
                        font-weight: 500;
                      "
                    >
                      Cancel
                    </button>
                  </div>
                </form>
              </div>

              <!-- Statistics Section -->
              <div>
                <h2
                  style="
                    margin-bottom: 2rem;
                    color: #374151;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                  "
                >
                  <i
                    data-lucide="bar-chart-3"
                    style="width: 1.5rem; height: 1.5rem; color: #71ad98"
                  ></i>
                  Your Statistics
                </h2>

                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1.5rem;
                  "
                >
                  <div
                    style="
                      text-align: center;
                      padding: 1.5rem;
                      background: #f8fafc;
                      border-radius: 0.5rem;
                    "
                  >
                    <div
                      style="font-size: 2rem; font-weight: bold; color: #71ad98"
                      id="quizzesCreated"
                    >
                      0
                    </div>
                    <div style="color: #6b7280; margin-top: 0.5rem">
                      Quizzes Created
                    </div>
                  </div>

                  <div
                    style="
                      text-align: center;
                      padding: 1.5rem;
                      background: #f8fafc;
                      border-radius: 0.5rem;
                    "
                  >
                    <div
                      style="font-size: 2rem; font-weight: bold; color: #71ad98"
                      id="questionsCreated"
                    >
                      0
                    </div>
                    <div style="color: #6b7280; margin-top: 0.5rem">
                      Questions Created
                    </div>
                  </div>

                  <div
                    style="
                      text-align: center;
                      padding: 1.5rem;
                      background: #f8fafc;
                      border-radius: 0.5rem;
                    "
                  >
                    <div
                      style="font-size: 2rem; font-weight: bold; color: #71ad98"
                      id="quizzesTaken"
                    >
                      0
                    </div>
                    <div style="color: #6b7280; margin-top: 0.5rem">
                      Quizzes Taken
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Lucide icons first
        lucide.createIcons();

        // Check authentication
        const token = localStorage.getItem("auth_token");
        const userInfo = JSON.parse(localStorage.getItem("user_info") || "{}");

        if (!token) {
          window.location.href = "/login";
          return;
        }

        // Update user name and setup dropdown
        const userName = document.getElementById("userName");
        if (userName && userInfo.full_name) {
          userName.textContent = userInfo.full_name;
          userName.style.display = "inline";

          // Setup dropdown after setting name
          setTimeout(setupUserDropdown, 100);
        }

        // Load user profile data
        loadUserProfile();
        loadUserStats();
      });

      // Dropdown functionality
      function setupUserDropdown() {
        const userName = document.querySelector(".user-name");
        const userSection = document.querySelector(".user-info");

        if (!userName || !userSection) return;

        // Check if dropdown already exists
        if (userSection.parentNode.classList.contains("user-dropdown")) return;

        const dropdownMenu = document.createElement("div");
        dropdownMenu.className = "dropdown-menu";
        dropdownMenu.innerHTML = `
                <a href="/dashboard" class="dropdown-item">Dashboard</a>
                <a href="/profile" class="dropdown-item">Profile</a>
                <a href="/my-quizzes" class="dropdown-item">My Quizzes</a>
                <a href="/browse-quizzes" class="dropdown-item">Browse All Quizzes</a>
                <button class="dropdown-item" onclick="logout()">Logout</button>
            `;

        const dropdownWrapper = document.createElement("div");
        dropdownWrapper.className = "user-dropdown";

        userSection.parentNode.insertBefore(dropdownWrapper, userSection);
        dropdownWrapper.appendChild(userSection);
        dropdownWrapper.appendChild(dropdownMenu);

        dropdownWrapper.addEventListener("mouseenter", () => {
          dropdownMenu.classList.add("show");
        });

        dropdownWrapper.addEventListener("mouseleave", () => {
          dropdownMenu.classList.remove("show");
        });
      }

      function logout() {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("user_info");
        window.location.href = "/";
      }

      // Notification System
      function showNotification(title, message, type = "info") {
        const existingNotifications =
          document.querySelectorAll(".notification");
        existingNotifications.forEach((notif) => notif.remove());

        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;

        notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
        }, 100);

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 4000);
      }

      function loadUserProfile() {
        const userInfo = JSON.parse(localStorage.getItem("user_info") || "{}");

        document.getElementById("firstName").value = userInfo.first_name || "";
        document.getElementById("lastName").value = userInfo.last_name || "";
        document.getElementById("email").value = userInfo.email || "";
      }

      async function loadUserStats() {
        try {
          const token = localStorage.getItem("auth_token");

          // Use the new user stats API endpoint
          const statsResponse = await fetch("/user/stats", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (statsResponse.ok) {
            const stats = await statsResponse.json();
            
            document.getElementById("quizzesCreated").textContent = stats.quizzes_created;
            document.getElementById("questionsCreated").textContent = stats.questions_created;
            document.getElementById("quizzesTaken").textContent = stats.quizzes_taken;
          } else {
            // Fallback to showing 0s if API fails
            document.getElementById("quizzesCreated").textContent = "0";
            document.getElementById("questionsCreated").textContent = "0";
            document.getElementById("quizzesTaken").textContent = "0";
          }
        } catch (error) {
          console.error("Error loading user stats:", error);
          // Show 0s on error
          document.getElementById("quizzesCreated").textContent = "0";
          document.getElementById("questionsCreated").textContent = "0";
          document.getElementById("quizzesTaken").textContent = "0";
        }
      }

      // Profile form submission
      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const firstName = document.getElementById("firstName").value;
          const lastName = document.getElementById("lastName").value;

          // For now, just update localStorage (would need API endpoint for actual update)
          const userInfo = JSON.parse(
            localStorage.getItem("user_info") || "{}"
          );
          userInfo.first_name = firstName;
          userInfo.last_name = lastName;
          userInfo.full_name = `${firstName} ${lastName}`;

          localStorage.setItem("user_info", JSON.stringify(userInfo));

          // Update the navbar
          document.getElementById("userName").textContent = userInfo.full_name;

          showNotification(
            "Profile Updated",
            "Your profile has been updated successfully!",
            "success"
          );
        });

      // Cancel button
      document.getElementById("cancelBtn").addEventListener("click", () => {
        loadUserProfile(); // Reset form
      });

      // Password form submission
      document
        .getElementById("passwordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const currentPassword =
            document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          // Validate passwords match
          if (newPassword !== confirmPassword) {
            showNotification(
              "Password Mismatch",
              "New passwords do not match!",
              "error"
            );
            return;
          }

          // Validate password length
          if (newPassword.length < 6) {
            showNotification(
              "Password Too Short",
              "Password must be at least 6 characters long!",
              "error"
            );
            return;
          }

          try {
            const token = localStorage.getItem("auth_token");
            const response = await fetch("/user/change-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
              }),
            });

            const data = await response.json();

            if (response.ok) {
              showNotification(
                "Password Changed",
                "Your password has been updated successfully!",
                "success"
              );
              // Clear form
              document.getElementById("passwordForm").reset();
            } else {
              showNotification(
                "Password Change Failed",
                data.error || "Failed to change password",
                "error"
              );
            }
          } catch (error) {
            console.error("Error changing password:", error);
            showNotification(
              "Error",
              "An error occurred while changing password",
              "error"
            );
          }
        });

      // Cancel password button
      document
        .getElementById("cancelPasswordBtn")
        .addEventListener("click", () => {
          document.getElementById("passwordForm").reset();
        });
    </script>
  </body>
</html>
